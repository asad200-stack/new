// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

enum StoreRole {
  OWNER
  EDITOR
  VIEWER
}

enum StoreLocale {
  EN
  AR
}

enum StoreLayoutStyle {
  GRID
  CARDS
}

enum ActivityType {
  PRODUCT_CREATED
  PRODUCT_UPDATED
  PRODUCT_DELETED
  PRODUCT_PRICE_CHANGED
  PRODUCT_VISIBILITY_CHANGED
  CATEGORY_CREATED
  CATEGORY_UPDATED
  TAG_CREATED
  TAG_UPDATED
  USER_ADDED
  STORE_SETTINGS_UPDATED
  MEDIA_UPLOADED
  MEDIA_DELETED
  MESSAGE_RECEIVED
}

model User {
  id           String            @id @default(cuid())
  email        String            @unique
  name         String
  passwordHash String
  createdAt    DateTime          @default(now())
  memberships  StoreMembership[]
  activityLogs ActivityLog[]     @relation("ActivityActor")
}

model Store {
  id           String            @id @default(cuid())
  name         String
  slug         String            @unique
  createdAt    DateTime          @default(now())

  settings     StoreSettings?
  stats        StoreStat?

  memberships  StoreMembership[]
  products     Product[]
  categories   Category[]
  tags         Tag[]
  mediaFiles   MediaFile[]
  customers    Customer[]
  messages     Message[]
  activityLogs ActivityLog[]
}

model StoreMembership {
  id        String    @id @default(cuid())
  storeId   String
  userId    String
  role      StoreRole @default(OWNER)
  createdAt DateTime  @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storeId, userId])
  @@index([userId])
  @@index([storeId, role])
}

model StoreSettings {
  id            String           @id @default(cuid())
  storeId       String           @unique

  primaryColor  String?
  fontFamily    String?
  layoutStyle   StoreLayoutStyle @default(GRID)
  enableArabic  Boolean          @default(false)
  defaultLocale StoreLocale      @default(EN)

  logoMediaId   String?
  bannerMediaId String?
  coverMediaId  String?

  store  Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  logo   MediaFile? @relation("StoreLogo", fields: [logoMediaId], references: [id], onDelete: SetNull)
  banner MediaFile? @relation("StoreBanner", fields: [bannerMediaId], references: [id], onDelete: SetNull)
  cover  MediaFile? @relation("StoreCover", fields: [coverMediaId], references: [id], onDelete: SetNull)
}

model MediaFile {
  id        String   @id @default(cuid())
  storeId   String
  key       String
  folder    String?
  filename  String
  mimeType  String
  sizeBytes Int
  width     Int?
  height    Int?
  sha256    String?  @db.VarChar(64)
  createdAt DateTime @default(now())

  store            Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productImages    ProductImage[]
  usedAsStoreLogo   StoreSettings[] @relation("StoreLogo")
  usedAsStoreBanner StoreSettings[] @relation("StoreBanner")
  usedAsStoreCover  StoreSettings[] @relation("StoreCover")

  @@unique([storeId, key])
  @@index([storeId, createdAt])
}

model Category {
  id        String   @id @default(cuid())
  storeId   String
  name      String
  slug      String
  createdAt DateTime @default(now())

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([storeId, slug])
  @@index([storeId])
}

model Tag {
  id        String   @id @default(cuid())
  storeId   String
  name      String
  slug      String
  createdAt DateTime @default(now())

  store    Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products ProductTag[]

  @@unique([storeId, slug])
  @@index([storeId])
}

model Product {
  id              String   @id @default(cuid())
  storeId         String
  name            String
  description     String?
  specs           String?
  sku             String?
  currency        String   @default("USD")
  originalPrice   Int
  discountedPrice Int?
  discountEnabled Boolean  @default(false)
  stockQty        Int      @default(0)
  isActive        Boolean  @default(true)
  categoryId      String?
  viewCount       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  store    Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  images   ProductImage[]
  tags     ProductTag[]

  @@index([storeId, isActive])
  @@index([storeId, createdAt])
  @@index([storeId, sku])
}

model ProductImage {
  id          String   @id @default(cuid())
  productId   String
  mediaFileId String
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  mediaFile MediaFile @relation(fields: [mediaFileId], references: [id], onDelete: Cascade)

  @@unique([productId, mediaFileId])
  @@index([productId, sortOrder])
}

model ProductTag {
  productId String
  tagId     String
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@index([tagId])
}

model Customer {
  id        String   @id @default(cuid())
  storeId   String
  name      String
  email     String
  phone     String?
  createdAt DateTime @default(now())

  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([storeId, email])
  @@index([storeId, createdAt])
}

model Message {
  id         String   @id @default(cuid())
  storeId    String
  customerId String
  content    String
  createdAt  DateTime @default(now())

  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([storeId, createdAt])
  @@index([customerId, createdAt])
}

model ActivityLog {
  id          String       @id @default(cuid())
  storeId     String
  actorUserId String?
  type        ActivityType
  entityType  String?
  entityId    String?
  meta        Json?
  createdAt   DateTime     @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  actor User? @relation("ActivityActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([storeId, createdAt])
  @@index([actorUserId, createdAt])
}

model StoreStat {
  storeId          String   @id
  visitCount       Int      @default(0)
  productViewCount Int      @default(0)
  messageCount     Int      @default(0)
  updatedAt        DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
}
